# Rbemail

## Motivation
On a quest for developing double-static websites (sites that are comprised of static files as well as being served statically through a CDN), it became necessary to develop a small script that will live on an external STMP server, accept input from form fields displayed on the website, and send mail. PHP was deemed too insecure, so it's written in Ruby using Sinatra for development and testing, and Pony for sending mail.

## What it does
When a user fills out the mail form, it sends mail to the destination email address as configured in the environment_variables.list file

## How it works
When a user fills out the mail form, it takes the form fields, checks to ensure required fields (as specified in environment_variables.list) are filled out, and checks the email address using a basic Regex formatter to make sure it at least looks like an email address.  Then, if all is good, it submits the form via Pony to an external SMTP server.  If all is not good, it pops back error messages using JSON and AJAX and requires resubmission of the form

## How to use it
Front-end users fill out the website form and click send

### External Dependencies
Ruby 2.1.2

Gems:
- sinatra
- sinatra-cross_origin
- pony
- mail
- mime-types
- json
- shotgun (dev only)

## Reference implementation

### Drupal Site
Our current site is written in Drupal.  We are maintaining a Drupal backend but having a static front end (served behind a CDN - "double static") is far more preferable than leaving a database backend exposed to the client side.  Therefore, we have our Drupal site on a staging server, which generates static site content and pushes it to a production server.  Rbemail is currently implemented as a Drupal module, so the client-side code that calls to the rbemail instance is embedded in the static content that is generated by the backend static site generation process.

### Managing services

#### [CLIENT SIDE]
The Drupal module uses JS & AJAX to call to the rbemail script to validate and send data from a contact form (in our case, the Drupal site will be turned into static files on deployment, so this module allows for email to be sent with an external mail program, rather than through the Drupal site's database and server).

#### [MAIL SERVER]
The SMTP mail server for our current configuration is Amazon SES.  We created new SES credentials, and verified the sender email and the domain on which rbemail will be used.  We configured the environment_variables.list file to include the AWS SES server name, port, user and pass, and the website domain we'll be using this app on.

#### [RBEMAIL SERVER]
The rbemail instance is run in a cluster of Docker containers.  
<p style="color:red;font-size:18px">TODO: Sunil - please expand on this.</p>

### Production Implementation

#### Where is this thing?

Rbemail currently lives on a cluster of Docker containers
<p style="color:red;font-size:18px">TODO: Sunil - please expand on this.</p>

## For developers

Set up dev environment:
1. Develop your form using html
1. Set up an SMTP server
  1. Recommended: install and run a local SMTP server/mock server *(e.g. FakeSMTP)*
  1. Alternative: set up a 3rd part SMTP server *(Amazon SES, etc.)*
1. Clone **rbemail** to your local machine
1. `cd path/to/project`
1. If you're using rvm, a gemset should automatically generate at the previous step
1. `bundle install`
1. `cp .env.production.example .env.production`
1. Using your text editor of choice, configure `environment_variables.list` with your specific form fields and SMTP server *(e.g the mock SMTP server you set up)*
1. Add ENV variables to your local session *(this command works in Ubuntu 14.10 - ymmv, but if done this way, you must do this every time you open a new shell, before you run the app):* `. <(sed '/^export/!s/^/export /' "lib/environment_variables.list")`
1. Configure client-side *(see `public/examples` for some implementation examples based on different client-side environments)*
  1. When developing a form, you can use the
1. Fire up the app inside the project directory using shotgun: `shotgun lib/rbemail.rb`
1. Navigate to `localhost:9393` (or wherever your form is) and test it out

### Deployment
1. Clone **rbemail** to your server
1. `cd path/to/project`
1. If you're using rvm, a gemset should automatically generate at the previous step
1. `bundle install`
1. `cp .env.production.example .env.production`
1. Using your text editor of choice, configure `environment_variables.list` with your specific form fields and live SMTP server
1. Run environment variables `sed` command as listed above
<p style="color:red;font-size:18px">TODO: Sunil - please expand on this - docker implementation? etc.</p>
1. Configure client-side to interact (see `public/examples` for some implementation examples based on different client-side environments)
1. Test
1. Enjoy!


## Contributors

- **M**anager - Ian Reynolds
- **O**wner   - Kate Klemp
- **C**onsulted - Sunil Chopra
- **H**elper    - #ruby-lang irc channel :)
- **A**pprover  - Sunil Chopra
